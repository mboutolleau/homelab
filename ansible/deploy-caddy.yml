---
- hosts: all
  tasks:
  - name: Create temporary download directory
    tempfile:
      state: directory
    register: tempdir

  - name: Download Caddy Debian package from official GitHub Page
    get_url:
      # Caddy 2.1.1 for Linux amd64 Debian package
      url: https://github.com/caddyserver/caddy/releases/download/v2.1.1/caddy_2.1.1_linux_amd64.deb
      dest: "{{ tempdir.path }}/caddy.deb"
      # SHA-512 sum of the Debian package from the cheksums file of the GitHub release page
      checksum: sha512:7b22585c324ced73673bff743d2e19370873097ee852b253075918466f3074b988458d514d8d87f9bcc08b57949307c63831bffc99c0091cc6254f45961dd937

  - name: Install Caddy Debian package
    apt:
      deb: "{{ tempdir.path }}/caddy.deb"
    become: yes
    register: deb_install_status
    # Execute the task only on Debian-based hosts
    when: ansible_facts['os_family'] == "Debian"

  - name: Remove the temporary directory
    file:
      path: "{{ tempdir.path }}"
      state: absent
    when: tempdir.path is defined

  - name: Create caddy directory, if it does not exist
    file:
      path: /etc/caddy
      state: directory
      owner: root
      group: root
      mode: '0755'
    become: yes

  - name: Copy provided Caddyfile example
    copy:
      dest: /etc/caddy/Caddyfile
      src: ../software/caddy/Caddyfile
      # the file will only be transferred if the destination does not exist
      force: no
      owner: root
      group: root
      mode: '0644'

  - name: Copy provided systemd unit
    copy:
      dest: /etc/systemd/system/caddy.service
      src: ../software/caddy/caddy.service
      # the file will only be transferred if the destination does not exist
      force: no
      owner: root
      group: root
      mode: '0644'
    register: unit_copy_status

  - name: Reload systemd daemon
    systemd:
      daemon_reload: yes
    become: yes
    # run only when a new systemd unit was copied
    when: unit_copy_status.changed

  - name: Restart Caddy service
    systemd:
      name: caddy
      state: restarted
    become: yes
    # run only when a new Debian package was installed
    when: deb_install_status.changed